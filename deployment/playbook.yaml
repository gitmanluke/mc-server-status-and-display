---
- name: Deploy Minecraft Server Monitor
  hosts: all
  become: true

  tasks:
    - name: Update apt cache and install required packages
      apt:
        name:
          - git
          - python3-venv
          - unclutter
          - chromium
        state: present
        update_cache: yes

    - name: Clone or update Git repository
      git:
        repo: 'https://github.com/gitmanluke/mc-server-status-and-display.git'
        dest: /home/{{ ansible_user }}/minecraft-monitor
        update: yes

    - name: Create Python virtual environment
      command: python3 -m venv /home/{{ ansible_user }}/minecraft-monitor/venv
      args:
        creates: /home/{{ ansible_user }}/minecraft-monitor/venv/bin/activate

    - name: Install Python packages from requirements.txt
      pip:
        requirements: /home/{{ ansible_user }}/minecraft-monitor/requirements.txt
        virtualenv: /home/{{ ansible_user }}/minecraft-monitor/venv

    - name: Deploy FastAPI systemd service
      template:
        src: templates/minecraft-monitor.service.j2
        dest: /etc/systemd/system/minecraft-monitor.service
        mode: '0644'

    - name: Deploy Chromium kiosk systemd service
      template:
        src: templates/chromium-kiosk.service.j2
        dest: /etc/systemd/system/chromium-kiosk.service
        mode: '0644'

    - name: Reload systemd daemon
      systemd:
        daemon_reload: yes

    - name: Enable and start FastAPI service
      systemd:
        name: minecraft-monitor
        enabled: yes
        state: restarted

    - name: Enable and start Chromium kiosk service
      systemd:
        name: chromium-kiosk
        enabled: yes
        state: restarted